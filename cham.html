<!DOCTYPE html>
<html>
<head>
  <style>
    #letter-blue {
      position: absolute;
      top: 50%;
      left: 50px;
      transform: translateY(-50%);
      font-size: 40px;
      font-weight: bold;
      color: blue;
      z-index: 1;
    }
    #letter-red {
      position: absolute;
      top: 50%;
      right: 50px;
      transform: translateY(-50%);
      font-size: 40px;
      font-weight: bold;
      color: red;
      z-index: 1;
    }
    #canvas {
      display: block;
      margin: auto;
      border: 1px solid black;
    }
    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: white;
      z-index: 9999;
      display: none;
    }
    #timer {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 20px;
      z-index: 1;
    }
    #confidence {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 20px;
      text-align: center;
      display: none;
      z-index: 2;
    }
    #confidence-buttons {
      text-align: center;
      margin-top: 10px;
    }
    #confidence-buttons button {
      display: inline-block;
      margin-bottom: 0 10px;
      padding: 5px 10px;
    }
    #submit-button {
      display: inline-block;
      text-align: center;
      margin-top: 20px;
      z-index: 5;
    }
  </style>
</head>
<body>
  <div id="letter-blue">B</div>
  <div id="letter-red">R</div>
  <canvas id="canvas" width="500" height="500"></canvas>
  <div id="overlay"></div>
  <div id="timer"></div>
  <div id="confidence" style="display: none;">
    How confident do you feel<br>(1 = a guess, 5 = 100% sure you're right)?<br>
    <div id="confidence-buttons">
      <button>1</button>
      <button>2</button>
      <button>3</button>
      <button>4</button>
      <button>5</button>
    </div>
    <br>
    <button id="submit-button">Submit</button>
  </div>
  <script>
    // Wrap JavaScript code inside a DOMContentLoaded event listener
    document.addEventListener("DOMContentLoaded", function() {
      // Get references to the buttons
      const confidenceButtons = document.querySelectorAll('#confidence-buttons button');

      let selectedConfidence = 0; // Initialize with a default value
      let countdownMilliseconds; // Countdown duration in milliseconds
      let remainingMilliseconds; // Remaining milliseconds on the countdown

      // Attach event listeners to the buttons (capture the clicked button's value)
      confidenceButtons.forEach((button, index) => {
        button.addEventListener('click', () => {
          selectedConfidence = index + 1; // Store the selected confidence value
          submitConfidence(selectedConfidence); // Call the submitConfidence function
        });
      });

      // Define the shapes and their corresponding log likelihood ratios
      const shapes = [
        {shape: "hexagon", llr: -0.9},
        {shape: "circle", llr: -0.7},
        {shape: "square", llr: -0.5},
        {shape: "triangle", llr: -0.3},
        {shape: "rectangle", llr: 0.3},
        {shape: "semicircle", llr: 0.5},
        {shape: "heart", llr: 0.7},
        {shape: "star", llr: 0.9}
      ];

      // Set up the canvas
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");

      // Initialize variables
      let shapeCounter = 0; // Counter variable for the number of shapes drawn
      const shapeDelay = 500; // Delay between showing shapes in ms
      const maxShapes = 20; // Max number of shapes (20)
      let currentShapeTimeoutId; // Timeout ID for controlling shape drawing
      let startTime; // Start time of shape drawing
      let isPaused = false; // Flag to indicate if the timer is paused

      // Define the function to draw a shape at the center of the canvas
      function drawShape() {
        // Check if the confidence page is being displayed
        if (document.getElementById("confidence").style.display === "block") {
          return; // Do not continue drawing shapes if on confidence page
        }

        // Clear the canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Generate a random shape index
        const randomShapeIndex = Math.floor(Math.random() * shapes.length);

        // Get the current shape and its log likelihood ratio
        const currentShape = shapes[randomShapeIndex];
        const currentShapeLLR = currentShape.llr;

        // Calculate the concentration value based on the LLR
        const concentration = Math.abs(currentShapeLLR) * 75;

        // Calculate the color based on the concentration value and LLR sign
        let color;

        if (currentShapeLLR < 0) {
          color = `rgba(0, 0, 255, ${concentration / 100})`; // Blue color
        } else {
          color = `rgba(255, 0, 0, ${concentration / 100})`; // Red color
        }

        // Draw the current shape at the center of the canvas
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const size = 100;

        ctx.beginPath();

        switch (currentShape.shape) {
          case "hexagon":
            ctx.moveTo(centerX + size/2 * Math.cos(0), centerY + size/2 * Math.sin(0));
            for (let i = 1; i <= 6; i++) {
              ctx.lineTo(centerX + size/2 * Math.cos(i * 2 * Math.PI / 6), centerY + size/2 * Math.sin(i * 2 * Math.PI / 6));
            }
            break;

          case "circle":
            ctx.arc(centerX, centerY, size / 2, 0, 2 * Math.PI);
            break;

          case "square":
            ctx.rect(centerX - size / 2, centerY - size / 2, size, size);
            break;

          case "triangle":
            ctx.moveTo(centerX - size / 2, centerY + size / 2);
            ctx.lineTo(centerX + size / 2, centerY + size / 2);
            break;

          case "rectangle":
            ctx.rect(centerX - size/1.5, centerY - size / 3, 2 * size/1.5, size/1.5);
            break;

          case "semicircle":
            ctx.arc(centerX, centerY, size / 2, 0, Math.PI, true);
            break;

          case "heart":
            ctx.moveTo(centerX, centerY + size / 4);
            ctx.bezierCurveTo(centerX - size / 2, centerY - size / 2, centerX - size, centerY - size / 4, centerX, centerY + size / 2);
            ctx.bezierCurveTo(centerX + size, centerY - size / 4, centerX + size / 2, centerY - size / 2, centerX, centerY + size / 4);
            break;

          case "star":
            const innerRadius = size / 4;
            const outerRadius = size/2;
            const spikes = 5;
            const rotation = Math.PI / 2;

            ctx.moveTo(centerX + outerRadius * Math.cos(rotation), centerY + outerRadius * Math.sin(rotation));

            for (let i = 0; i < spikes; i++) {
              const outerX = centerX + outerRadius * Math.cos(rotation + (i * 2 * Math.PI / spikes));
              const outerY = centerY + outerRadius * Math.sin(rotation + (i * 2 * Math.PI / spikes));
              ctx.lineTo(outerX, outerY);

              const innerX = centerX + innerRadius * Math.cos(rotation + ((i + 0.5) * 2 * Math.PI / spikes));
              const innerY = centerY + innerRadius * Math.sin(rotation + ((i + 0.5) * 2 * Math.PI / spikes));
              ctx.lineTo(innerX, innerY);
            }
            break;
        }

        ctx.closePath();
        ctx.fillStyle = color;
        ctx.fill();

        // Output the value of the current shape to the console
        console.log("Current shape value:", currentShapeLLR);

        // Increment the shape counter
        shapeCounter++;

        // Check if the maximum number of shapes has been reached
        if (shapeCounter < maxShapes) {
          // Schedule the next shape to be drawn after the delay
          currentShapeTimeoutId = setTimeout(drawShape, shapeDelay);
        } else {
          // All shapes have been drawn, make the entire screen blank
          document.getElementById("overlay").style.display = "block";
          document.getElementById("confidence").style.display = "block";
        }
      }

      // Start drawing shapes
      startTime = Date.now();
      drawShape();

      // Randomize the countdown duration between 5000 and 10000 milliseconds
      countdownMilliseconds = Math.floor(Math.random() * (10000 - 5000 + 1)) + 5000;

      // Calculate the remaining milliseconds on the countdown
      remainingMilliseconds = countdownMilliseconds - (Date.now() - startTime);

      // Display and update the countdown timer
      const timerElement = document.getElementById("timer");
      timerElement.textContent = remainingMilliseconds;

      // Function to handle the "Oh dear" message when the timer reaches 0
      function outOfTimeMessage() {
        document.getElementById("confidence").innerHTML =
          "Oh dear, you ran out of time! Click the button below to move on to a new trial :(";
        document.getElementById("confidence").style.display = "block";
      }

      // Add event listener for arrow key presses
      window.addEventListener("keydown", function(event) {
        if (event.code === "ArrowLeft" || event.code === "ArrowRight") {
          // Pause the timer and shape drawing
          isPaused = true;
          clearTimeout(currentShapeTimeoutId);
          clearTimeout(updateTimerId);

          const arrowPressed = event.code === "ArrowLeft" ? "Left" : "Right";
          console.log(`Arrow ${arrowPressed} key pressed`); // Log the event

          // Show the confidence page without resetting the timer
          showConfidencePage();
        }
      });


      let shapesCompleted = false;

      // Function to restart drawing shapes
      function restartShapes() {
        document.getElementById("letter-blue").style.display = "block";
        document.getElementById("letter-red").style.display = "block";
        document.getElementById("canvas").style.display = "block";
        document.getElementById("confidence").style.display = "none";
        document.getElementById("timer").style.display = "block";
        shapeCounter = 0;
        shapesCompleted = false;
        document.body.style.backgroundColor = "transparent"; // Reset background color

        // Randomize the countdown duration between 5000 and 10000 milliseconds
        countdownMilliseconds = Math.floor(Math.random() * (10000 - 5000 + 1)) + 5000;
        remainingMilliseconds = countdownMilliseconds;

        // Update and display the countdown timer
        const timerElement = document.getElementById("timer");
        timerElement.textContent = remainingMilliseconds;

        currentShapeTimeoutId = setTimeout(drawShape, shapeDelay);
        startTime = Date.now();
      }


      // Function to stop drawing shapes and show confidence message
      function stopDrawing() {
        clearTimeout(currentShapeTimeoutId); // Stop further shape drawing
        document.getElementById("confidence").style.display = "block"; // Display the confidence message
        document.getElementById("letter-blue").style.display = "none"; // Hide blue letter
        document.getElementById("letter-red").style.display = "none"; // Hide red letter
        document.getElementById("canvas").style.display = "none"; // Hide canvas
        document.getElementById("timer").style.display = "none"; // Hide timer
      }

      // Function to submit confidence and restart drawing shapes
      function submitConfidence(confidence) {
        // Handle the user's confidence value here
        // You can do whatever you need with the 'confidence' value

        // Reset the timer
        clearTimeout(currentShapeTimeoutId);

        // Update the countdown values based on the remaining time
        countdownMilliseconds = remainingMilliseconds;

        // // Calculate the 'confidence' based on the 'selectedConfidence' value
        const calculatedConfidence = confidence; // Update the formula as needed

        // Use the calculated 'confidence' value in your code
        console.log("Calculated confidence:", calculatedConfidence);

        // Show all the elements on the screen except the confidence message
        document.getElementById("letter-blue").style.display = "block";
        document.getElementById("letter-red").style.display = "block";
        document.getElementById("canvas").style.display = "block";
        document.getElementById("confidence").style.display = "none";
        document.getElementById("timer").style.display = "block";

        // Start drawing shapes again
        shapeCounter = 0;
        document.body.style.backgroundColor = "transparent"; // Reset background color
        currentShapeTimeoutId = setTimeout(drawShape, shapeDelay);
        startTime = Date.now();
        remainingMilliseconds = countdownMilliseconds;
        updateTimer();

        // Hide the confidence message
        document.getElementById("confidence").style.display = "none";

        // Reset the timer
        clearTimeout(currentShapeTimeoutId);

        // Call the restartShapes function to restart the shapes code
        restartShapes();
      }


      // Declare the updateTimerId variable at the top
      let updateTimerId;

      // Function to update the timer and handle "Oh dear" message
      function updateTimer() {
        if (!isPaused) {
          remainingMilliseconds = countdownMilliseconds - (Date.now() - startTime);
          remainingMilliseconds = Math.max(remainingMilliseconds, 0); // Prevent negative numbers
          document.getElementById("timer").textContent = remainingMilliseconds;

          if (remainingMilliseconds <= 0) {
            isPaused = true; // Pause the timer
            clearTimeout(currentShapeTimeoutId);
            clearTimeout(updateTimerId);
            outOfTimeMessage(); // Display the "Oh dear" message
          }
        }
      }


      // Function to handle arrow key presses and show the confidence page
      function showConfidencePage() {
        if (!isPaused) {
          isPaused = true; // Pause the timer
          clearTimeout(currentShapeTimeoutId); // Stop further shape drawing
          clearTimeout(updateTimerId);
        }

        // Hide all the elements on the screen
        document.getElementById("letter-blue").style.display = "none";
        document.getElementById("letter-red").style.display = "none";
        document.getElementById("canvas").style.display = "none";
        document.getElementById("overlay").style.display = "none";
        document.getElementById("timer").style.display = "none";

        // Check if the timer ran out or the user pressed an arrow key
        if (remainingMilliseconds <= 0) {
          outOfTimeMessage(); // Display the "Oh dear" message
        } else {
          document.getElementById("confidence").style.display = "block"; // Show the confidence page
        }
      }

      // Call the updateTimer function to start the countdown
      updateTimerId = setInterval(updateTimer, 100);

      // Move the submit button event listener binding here
      document.getElementById("submit-button").addEventListener("click", restartShapes);

      // Wrap the main code inside a function that handles the repeating pattern
      function runPattern() {
        // Declare countdownMilliseconds and remainingMilliseconds
        let countdownMilliseconds;
        let remainingMilliseconds;

        // Function to start the shapes/timer sequence
        function startShapesTimer() {
          // Reset canvas and other elements
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          document.getElementById("overlay").style.display = "none";
          document.getElementById("confidence").style.display = "none";
          document.getElementById("letter-blue").style.display = "block";
          document.getElementById("letter-red").style.display = "block";
          document.getElementById("timer").style.display = "block";

          // Restart drawing shapes
          shapeCounter = 0;
          document.body.style.backgroundColor = "transparent"; // Reset background color
          currentShapeTimeoutId = setTimeout(drawShape, shapeDelay);
          startTime = Date.now();

          // Reset the timer
          countdownMilliseconds = Math.floor(Math.random() * (10000 - 5000 + 1)) + 5000;
          remainingMilliseconds = countdownMilliseconds;

          // Update and display the countdown timer
          const timerElement = document.getElementById("timer");
          timerElement.textContent = remainingMilliseconds;

          // Randomize the countdown duration between 5000 and 10000 milliseconds
          countdownMilliseconds = Math.floor(Math.random() * (10000 - 5000 + 1)) + 5000;
          remainingMilliseconds = countdownMilliseconds;

        }

        // Function to start the confidence page
        function startConfidencePage() {
          document.getElementById("letter-blue").style.display = "none";
          document.getElementById("letter-red").style.display = "none";
          document.getElementById("canvas").style.display = "none";
          document.getElementById("overlay").style.display = "none";
          document.getElementById("timer").style.display = "none";
          document.getElementById("confidence").style.display = "block";
        }

        // Function to handle the confidence submission
        function handleConfidenceSubmission(confidence) {
          // Handle the user's confidence value here

          // Run the shapes/timer sequence again
          startShapesTimer();
        }

        // Start the first shapes/timer sequence
        startShapesTimer();

        // Set up event listener for confidence submission
        const submitButton = document.getElementById("submit-button");
        submitButton.addEventListener("click", function() {
          submitConfidence(selectedConfidence);
        });
        }

    // Call the runPattern function to start the repeating pattern
    runPattern();
  });
  </script>
</body>
</html>
